name: Build MSE3

on:
  push:
    branches: [ master, main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install wxwidgets boost hunspell

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)

      - name: Bundle dylibs into app
        run: |
          APP_PATH="build/mse3.app"
          FRAMEWORKS_DIR="$APP_PATH/Contents/Frameworks"
          EXECUTABLE="$APP_PATH/Contents/MacOS/mse3"

          mkdir -p "$FRAMEWORKS_DIR"

          # Get list of non-system dylibs
          DYLIBS=$(otool -L "$EXECUTABLE" | grep -E '/opt/homebrew|/usr/local' | awk '{print $1}')

          # Copy each dylib and fix paths
          for DYLIB in $DYLIBS; do
            DYLIB_NAME=$(basename "$DYLIB")
            echo "Bundling $DYLIB_NAME..."
            cp "$DYLIB" "$FRAMEWORKS_DIR/"
            chmod 644 "$FRAMEWORKS_DIR/$DYLIB_NAME"

            # Update the executable to look in Frameworks
            install_name_tool -change "$DYLIB" "@executable_path/../Frameworks/$DYLIB_NAME" "$EXECUTABLE"

            # Also check if this dylib has its own dependencies
            SUB_DYLIBS=$(otool -L "$FRAMEWORKS_DIR/$DYLIB_NAME" | grep -E '/opt/homebrew|/usr/local' | awk '{print $1}')
            for SUB_DYLIB in $SUB_DYLIBS; do
              SUB_NAME=$(basename "$SUB_DYLIB")
              if [ ! -f "$FRAMEWORKS_DIR/$SUB_NAME" ]; then
                echo "  Also bundling dependency $SUB_NAME..."
                cp "$SUB_DYLIB" "$FRAMEWORKS_DIR/"
                chmod 644 "$FRAMEWORKS_DIR/$SUB_NAME"
              fi
              install_name_tool -change "$SUB_DYLIB" "@executable_path/../Frameworks/$SUB_NAME" "$FRAMEWORKS_DIR/$DYLIB_NAME"
            done

            # Fix the dylib's own ID
            install_name_tool -id "@executable_path/../Frameworks/$DYLIB_NAME" "$FRAMEWORKS_DIR/$DYLIB_NAME"
          done

          # Second pass: fix all cross-references between bundled dylibs
          for DYLIB_FILE in "$FRAMEWORKS_DIR"/*.dylib; do
            DYLIB_NAME=$(basename "$DYLIB_FILE")
            for OTHER_DYLIB in "$FRAMEWORKS_DIR"/*.dylib; do
              OTHER_NAME=$(basename "$OTHER_DYLIB")
              # Try to fix any remaining homebrew paths
              install_name_tool -change "/opt/homebrew/opt/wxwidgets/lib/$OTHER_NAME" "@executable_path/../Frameworks/$OTHER_NAME" "$DYLIB_FILE" 2>/dev/null || true
              install_name_tool -change "/opt/homebrew/Cellar/wxwidgets/3.2.4/lib/$OTHER_NAME" "@executable_path/../Frameworks/$OTHER_NAME" "$DYLIB_FILE" 2>/dev/null || true
            done
          done

          echo "Bundled libraries:"
          ls -la "$FRAMEWORKS_DIR"

          echo "Verifying executable dependencies:"
          otool -L "$EXECUTABLE"

      - name: Code sign app bundle
        run: |
          APP_PATH="build/mse3.app"

          # Ad-hoc sign all frameworks first
          for DYLIB in "$APP_PATH/Contents/Frameworks"/*.dylib; do
            codesign --force --sign - "$DYLIB"
          done

          # Then sign the main executable
          codesign --force --sign - "$APP_PATH/Contents/MacOS/mse3"

          # Finally sign the entire app bundle
          codesign --force --deep --sign - "$APP_PATH"

          echo "Verifying code signature:"
          codesign --verify --verbose "$APP_PATH"

      - name: Create DMG
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R build/mse3.app dmg_contents/

          # Create DMG
          hdiutil create -volname "MSE3" -srcfolder dmg_contents -ov -format UDZO MSE3-macOS.dmg

          ls -la MSE3-macOS.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: MSE3-macOS
          path: MSE3-macOS.dmg

  build-windows:
    runs-on: windows-latest
    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '13596c42018128edb32083a267c0c1ddfc935c1b'  # 2025.01.08 (latest)

      - name: Install dependencies (with retry)
        shell: pwsh
        run: |
          $maxRetries = 3
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries"

            try {
              vcpkg install wxwidgets:x64-windows-static boost:x64-windows-static hunspell:x64-windows-static
              $success = $true
            } catch {
              Write-Host "Attempt $retryCount failed: $_"
              if ($retryCount -lt $maxRetries) {
                Write-Host "Waiting 30 seconds before retry..."
                Start-Sleep -Seconds 30
              }
            }
          }

          if (-not $success) {
            throw "Failed to install dependencies after $maxRetries attempts"
          }

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows-static

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Package Windows build
        run: |
          mkdir MSE3-Windows
          cp build/Release/mse3.exe MSE3-Windows/
          cp -r resource MSE3-Windows/

          # Create zip
          Compress-Archive -Path MSE3-Windows -DestinationPath MSE3-Windows.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MSE3-Windows
          path: MSE3-Windows.zip

  # Create a release when a tag is pushed
  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: MSE3-macOS

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: MSE3-Windows

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MSE3-macOS.dmg
            MSE3-Windows.zip
          generate_release_notes: true
